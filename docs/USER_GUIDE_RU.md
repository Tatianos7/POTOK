# ПОТОК — подробная инструкция и логика работы

Документ описывает, как пользоваться приложением ПОТОК, куда ведут кнопки и что за что отвечает. Основано на текущей логике приложения (маршрутизация, страницы, сервисы).

---

## 1) Общая схема навигации

### Авторизация и доступы
- Все основные разделы защищены `ProtectedRoute`. Без авторизации вы попадёте на `/login`.
- После входа/регистрации — редирект на главную `/`.
- Страницы авторизации всегда в светлой теме.

### Карта маршрутов (основные)
- `/` — Dashboard (Главная)
- `/login`, `/register`, `/forgot-password` — вход/регистрация/восстановление
- `/profile`, `/profile/edit`, `/coach-history`
- `/goal`, `/goals`, `/goal/result`
- `/measurements`
- `/nutrition` (дневник питания)
  - `/nutrition/search` (поиск продуктов)
  - `/nutrition/recipe-analyzer` (анализатор рецептов)
  - `/nutrition/create-custom-product`
  - `/nutrition/create-brand-product`
  - `/nutrition/recipes`, `/nutrition/recipes/:id`
  - `/nutrition/favorites`
- `/workouts` (тренировки)
- `/habits` (привычки)
- `/progress` (прогресс)
- `/today` (день)
- `/my-program` (программа)
- `/paywall` (Premium)
- `/notifications` (уведомления)
- `/pose` (Pose Coach)
- `/import-exercises` (импорт упражнений)
- `/admin` (админ‑панель)

**Важно:** карточка «План тренировок и питания» на главной ведёт на `/plans`, но отдельной страницы для `/plans` сейчас нет. По настройке маршрутов это вернёт на `/`.

---

## 2) Главная (Dashboard)
**Путь:** `/`  
**Файл:** `src/pages/Dashboard.tsx`

### Что здесь есть
- Приветствие пользователя.
- Кнопка меню (справа вверху).
- Карточки разделов (Feature Cards):
  - План тренировок и питания → `/plans` (сейчас редирект на `/`)
  - ЦЕЛЬ → `/goals`
  - ЗАМЕРЫ → `/measurements`
  - ПИТАНИЕ → `/nutrition`
  - ТРЕНИРОВКИ → `/workouts` (помечено Premium)
  - ПРИВЫЧКИ → `/habits` (помечено Premium)
  - ПРОГРЕСС → `/progress` (помечено Premium)

### Как работает
- Нажатие на карточку открывает её `route`.
- Premium‑карточки помечаются бейджем, но не блокируются на UI‑уровне.
- Админы автоматически перенаправляются в `/admin`.

---

## 3) Боковое меню (Sidebar)
**Файл:** `src/components/Menu.tsx`

### Пункты меню
- **ПРОФИЛЬ** → `/profile`
- **УВЕДОМЛЕНИЯ** → `/notifications`  
  Показан индикатор «прочитано/непрочитано».
- **ОБЩИЕ НАСТРОЙКИ** → открывает `SettingsModal`
- **ПОДДЕРЖКА** → открывает `SupportForm`
- **Поделиться с друзьями** → UI‑кнопка (без перехода)
- **ВЫХОД** → выход из аккаунта и переход на `/login`

### Логика
- При открытии меню обновляется индикатор уведомлений.
- Индикатор учитывает непрочитанные/неархивированные уведомления.

---

## 4) Авторизация

### Вход
**Путь:** `/login`  
**Файл:** `src/pages/Login.tsx`

**Как пользоваться:**
- Введите email или телефон.
- Нажмите «Получить код».
  - Для email — приходит ссылка на почту.
  - Для телефона — приходит SMS‑код.
- Введите код и подтвердите.
- После успешного входа вы попадёте на `/`.

**Куда ведут кнопки:**
- «Забыли пароль?» → `/forgot-password`
- «Зарегистрироваться» → `/register`

### Регистрация
**Путь:** `/register`  
**Файл:** `src/pages/Register.tsx`

**Как пользоваться:**
- Заполните имя (обязательно), фамилию/отчество (опционально), email/телефон.
- Нажмите «Получить код» или «Отправить».
- Подтвердите кодом (SMS или email‑ссылка).

**Переходы:**
- После успешной регистрации → `/`
- Ссылка «Войти» возвращает на `/login`

### Восстановление пароля
**Путь:** `/forgot-password`  
**Файл:** `src/pages/ForgotPassword.tsx`

**Как пользоваться:**
- Введите email и отправьте ссылку.
- После отправки — автопереход на `/login`.

---

## 5) Профиль
**Путь:** `/profile`  
**Файл:** `src/pages/Profile.tsx`

### Что можно сделать
- Загрузить/изменить аватар (клик по фото).
- Просмотреть данные профиля и статус подписки.
- Управлять настройками AI‑коуча (режим, включение, голос).
- Управлять подпиской и историей платежей.
- Открыть политику конфиденциальности.
- Изменить пароль.
- Перейти в «Историю рекомендаций».

### Куда ведут кнопки
- «Редактировать профиль» → `/profile/edit`
- «История рекомендаций» → `/coach-history`
- Крестик (X) → `/`

### Логика
- Аватар сохраняется локально и синхронизируется с Supabase.
- Профиль и доступы подтягиваются через `uiRuntimeAdapter.getProfileState`.
- Отображаются статусы доверия/объяснимости коуча, если доступны.

### Редактирование профиля
**Путь:** `/profile/edit`  
**Файл:** `src/pages/EditProfile.tsx`

**Как пользоваться:**
- Изменить личные данные и сохранить.
- После сохранения — возврат назад.

---

## 6) Цель
**Путь:** `/goal` или `/goals`  
**Файл:** `src/pages/Goal.tsx`

### Что здесь происходит
- Создание цели по весу и времени.
- Хранение расчётных макросов (КБЖУ).
- Просмотр текущей цели и её прогресса.

### Действия и переходы
- «Создать цель» → открывает модальное окно.
- «Рассчитать» → `/goal/result` (передаются параметры формы).
- «Редактировать» → открывает модальное окно редактирования.
- Крестик (X) → `/`

### Логика расчёта
Финальный расчёт выполняется на странице результатов:
- BMR по формуле Харриса–Бенедикта.
- TDEE с учетом коэффициента активности.
- Калории с учетом цели (дефицит/профицит/поддержание).
- Макросы: белок 2 г/кг, жиры 0.9 г/кг, углеводы — остаток.
- Оценка времени достижения цели (до 12 месяцев).

### Результат цели
**Путь:** `/goal/result`  
**Файл:** `src/pages/GoalResult.tsx`

**Что видно:**
- Расчёт BMR/TDEE, калорий, БЖУ.
- Прогноз времени достижения (если цель — снижение веса).

**Кнопки:**
- «Сохранить цель» → сохраняет значения в Supabase и возвращает в `/goal`.
- «Назад» → `/goal`

---

## 7) Замеры
**Путь:** `/measurements`  
**Файл:** `src/pages/Measurements.tsx`

### Возможности
- Ввод замеров (вес, шея, плечи, грудь, спина).
- Добавление своих параметров.
- Загрузка фото (3 основных + до 10 дополнительных).
- История замеров и фото.

### Действия
- `+ / -` меняют значение на 0.5.
- Ввод вручную с проверкой формата.
- Клик по фото → загрузка файла.
- Удаление записей из истории.
- Крестик (X) → `/`

---

## 8) Питание (дневник питания)
**Путь:** `/nutrition`  
**Файл:** `src/pages/FoodDiary.tsx`

### Основные элементы
- Календарь недели (7 дней вперед) + раскрываемый календарь.
- Приемы пищи: завтрак/обед/ужин/перекус.
- Итого по калориям и БЖУ.
- Вкладки и модальные окна для добавления/анализа еды.

### Действия в приёме пищи
- **Плюс** → добавить продукт.
- **Три точки** → доп. действия:
  - Копировать приём пищи на другую дату.
  - Удалить приём пищи.
  - Добавить заметку к приёму пищи.
  - Сохранить приём пищи как рецепт.
- **Галочка** → отметить «съедено».
- Клик по продукту → редактирование количества и макросов.

### Встроенные инструменты
- Поиск продуктов.
- Сканирование штрих‑кода (встроенная камера/сканер).
- Анализ фото еды.
- Анализ рецепта по тексту.
- Создание пользовательских продуктов.

### Логика данных
- При сохранении данные пишутся в Supabase и кэшируются локально.
- Для анализа и рекомендаций передаются агрегированные данные по дню.

---

## 9) Поиск продуктов
**Путь:** `/nutrition/search`  
**Файл:** `src/pages/FoodSearch.tsx`

### Как пользоваться
- Введите запрос и выберите продукт.
- Можно открыть сканер штрих‑кода.
- Открывается модальное окно добавления продукта (с весом).
- После подтверждения продукт попадёт в дневник питания.

### Часто используемые
- Сохраняются локально в `recent_food_searches_{userId}`.
- При выборе продукта из «часто» открывается окно добавления с предзаполненным весом.

---

## 10) Анализатор рецепта
**Путь:** `/nutrition/recipe-analyzer`  
**Файл:** `src/pages/RecipeAnalyzer.tsx`

### Возможности
- Ввести текст рецепта.
- Загрузить фото рецепта.
- Нажать «Анализировать» → получаем список ингредиентов и макросы.
- Сохранить рецепт в «Мои рецепты».
- Добавить рецепт в дневник.

---

## 11) Рецепты
**Путь:** `/nutrition/recipes`  
**Файл:** `src/pages/Recipes.tsx`

### Логика
- Вкладки: «Мои», «Избранное», «Все».
- Фильтры по типу (белковые/углеводные/кето/вегетарианские/рыба).
- Фильтры по цели (сушка/набор/поддержание).
- Просмотр сеткой или списком.
- Клик по рецепту → `/nutrition/recipes/:id`.

### Детали рецепта
**Путь:** `/nutrition/recipes/:id`  
**Файл:** `src/pages/RecipeDetails.tsx`

**Что можно сделать:**
- Изменить вес порции → пересчёт макросов.
- Добавить рецепт в дневник (выбор приёма пищи и даты).
- Добавить фото рецепта.
- Добавить заметку.

---

## 12) Создание продуктов

### Свой продукт
**Путь:** `/nutrition/create-custom-product`  
**Файл:** `src/pages/CreateCustomProductPage.tsx`

**Как работает:**
- Заполняете название, КБЖУ, вес, категорию приёма пищи.
- Можно добавить в «Избранное».
- После сохранения продукт сразу добавляется в дневник выбранного дня.

### Брендовый продукт
**Путь:** `/nutrition/create-brand-product`  
**Файл:** `src/pages/CreateBrandProductPage.tsx`

**Отличия:**
- Есть поле «Название марки».
- В остальном логика как у собственного продукта.

---

## 13) Избранные продукты
**Путь:** `/nutrition/favorites`  
**Файл:** `src/pages/FavoritesProductsPage.tsx`

### Логика
- Раздел показывает **часто используемые** продукты из `recent_food_searches_{userId}`.
- Поиск по имени внутри списка.
- Клик по продукту → открывается окно добавления с предзаполненным весом.

---

## 14) Тренировки
**Путь:** `/workouts`  
**Файл:** `src/pages/Workouts.tsx`

### Возможности
- Выбор даты (быстрый календарь + полный календарь).
- Выбор категории упражнений → список упражнений.
- Создание собственного упражнения.
- Редактирование подходов/повторений/веса.
- Сохранение тренировки.

### Логика
- Данные пишутся в Supabase и дублируются в localStorage.
- После закрытия дня формируются данные для AI‑планов.
- Личные рекорды (PR) хранятся локально.

---

## 15) Привычки
**Путь:** `/habits`  
**Файл:** `src/pages/Habits.tsx`

### Возможности
- Создание привычек (название, описание, периодичность).
- Отметка выполнения.
- Навигация по датам.
- Отображение серий/статистики.

### Логика
- При отметке привычки создаётся или обновляется запись в журнале.
- Отправляются события коучу (HabitCompleted/HabitBroken).

---

## 16) Прогресс
**Путь:** `/progress`  
**Файл:** `src/pages/Progress.tsx`

### Что показывает
- Сводные метрики за период (30 дней).
- Тренды веса, объёма тренировок, питания.
- Таймлайн прогресса.

### Быстрые переходы
- «Сегодня» → `/today`
- «Моя программа» → `/my-program`
- «Привычки» → `/habits`
- «Замеры» → `/measurements`

---

## 17) Сегодня
**Путь:** `/today`  
**Файл:** `src/pages/Today.tsx`

### Что это
- Ежедневный обзор: план дня, питание, тренировки, привычки.
- Коуч‑сообщения, подсказки, состояние восстановления.
- Кнопка «Спросить коуча».

---

## 18) Моя программа
**Путь:** `/my-program`  
**Файл:** `src/pages/MyProgram.tsx`

### Возможности
- Просмотр фаз и недель программы.
- Статус дней (выполнено/пропущено).
- Управление программой: пауза, продолжение, перепланировка.

---

## 19) Paywall (Premium)
**Путь:** `/paywall`  
**Файл:** `src/pages/Paywall.tsx`

### Что здесь
- Статус подписки: free/trial/active/grace/expired.
- Объяснение логики доступа (TrustBanner).
- Карточки преимуществ Premium.

---

## 20) Уведомления
**Путь:** `/notifications`  
**Файл:** `src/pages/Notifications.tsx`

### Логика
- Вкладки: поддержка, сообщения, новости.
- Входящие/корзина.
- Можно пометить прочитанным, удалить, восстановить.

---

## 21) История коуча
**Путь:** `/coach-history`  
**Файл:** `src/pages/CoachHistory.tsx`

### Что доступно
- История решений и объяснений коуча.
- Эволюция доверия.
- Кнопки: «Очистить историю» и «Сбросить стиль общения».

---

## 22) Админ‑панель
**Путь:** `/admin`  
**Файл:** `src/pages/AdminPanel.tsx`

### Доступ
- Только для пользователей с флагом `isAdmin`.

### Функции
- Статистика пользователей.
- Обработка сообщений поддержки.
- Управление статусом администратора.
- Импорт и обслуживание данных.

---

## 23) Pose Coach (тренер поз)
**Путь:** `/pose`  
**Файл:** `src/pages/PoseCoach.tsx`

### Что делает
- Использует камеру и Mediapipe Pose для анализа позы.
- Показывает скелет, подсказки, уровень риска, задержки.
- Realtime‑режим зависит от уровня подписки (Free / Pro / Vision).

---

## 24) Импорт упражнений
**Путь:** `/import-exercises`  
**Файл:** `src/pages/ImportExercises.tsx`

### Логика
- При открытии страницы автоматически запускается импорт.
- Показывается статус: загрузка / успех / ошибка.
- После успеха можно перейти в `/workouts`.

---

## 25) Где хранятся данные

### Основное хранилище
- **Supabase** — основное хранилище для профиля, целей, питания, тренировок, привычек и уведомлений.

### Локальное кэширование
- Используется `localStorage` для быстрого UI и оффлайн‑поддержки:
  - `potok_daily_meals_{userId}` — кэш дневника питания.
  - `potok_workout_entries_{userId}` — кэш тренировок.
  - `recent_food_searches_{userId}` — часто используемые продукты.
  - `goal_{userId}` — доп. данные по цели (тип, даты).
  - `avatar_{userId}` — аватар.

---

## 26) Состояния загрузки и ошибок

Многие страницы используют `uiRuntimeAdapter`:
- **loading** — показ загрузки.
- **active** — показ данных.
- **empty** — данных нет.
- **error/offline** — ошибка или нет соединения.

На таких экранах доступны кнопки повторной попытки.

---

## 27) Коуч и объяснимость

Во многих разделах есть элементы AI‑коуча:
- Сообщения поддержки и подсказки.
- Объяснения решений (Explainability Drawer).
- Метрики доверия и безопасность.

Коуч реагирует на события пользователя: завершение тренировки, отметку привычек, закрытие дня и т.д.

---

## 28) Краткая схема «если нажать — куда попадёшь»

- Крестик (X) на большинстве страниц → `/`
- Меню → профиль / уведомления / настройки / поддержка / выход
- Карточка на Dashboard → соответствующий раздел
- Из «Питание» → поиск / анализатор / рецепты / создание продукта
- Из «Прогресс» → сегодня / программа / привычки / замеры

---

Если нужна ещё более подробная инструкция по конкретному разделу (например, подробно расписать работу модальных окон или все кнопки на странице Питания), скажите — допишу отдельный раздел.
