# Sprint 7.4.2 — Habits Engine (Architecture, Calm Power Coach)

## Цель
Привычки — фундамент устойчивости, а не «галочки». Слой привычек должен:
- поддерживать долгосрочную привязанность к продукту;
- укреплять доверие и самоконтроль без стыда;
- быть связующим звеном между Goal → дневниками → прогрессом → адаптацией.

---

## 1) Доменная модель

### Сущности
- `system_habits`
  - предустановленные привычки: шаги, регулярность тренировок, базовое восстановление, сон (фаза 2)
- `custom_habits`
  - пользовательские привычки (название, частота, напоминания)
- `habit_log`
  - ежедневные/еженедельные отметки выполнения
- `streak`
  - текущий стрик, лучший стрик
- `relapse`
  - срыв (не как ошибка, а как нормальный этап)
- `recovery`
  - восстановление после срыва
- `confidence_impact`
  - влияние на доверие (trust_score), адаптацию, мотивацию

### Атрибуты
- Частота: `daily | weekly`
- Статус: `inactive | active | streak | slip | recovery | stabilized`
- Мягкие метрики: `consistency_score`, `support_score`, `stress_risk`

---

## 2) Машина состояний привычки

`inactive → active → streak → slip → recovery → stabilized`

Пояснение:
- `streak` = стабильное выполнение
- `slip` = пропуск без наказания
- `recovery` = мягкое возвращение
- `stabilized` = привычка встроена в ритм

---

## 3) Связи с ядром продукта

### Goal
- привычки усиливают достижение цели
- влияют на прогноз траектории и темп изменения

### Measurements
- сон/восстановление повышают качество замеров
- при низкой регулярности — предупреждение «данные нестабильны»

### Food Diary
- привычки «сон/вода/режим» влияют на рекомендации по питанию

### Training Diary
- регулярность тренировок и восстановление влияют на риск перетренированности

### Progress
- привычки появляются как отдельный слой в timeline
- объяснение влияния («привычки усилили стабильность»)

### Trust / Adaptation / Coach
- привычки повышают trust_score
- при частых срывах — мягкий режим адаптации
- Coach поддерживает возврат без давления

---

## 4) Поведение в режимах

### Manual Mode
Привычки = опора самоконтроля
- мягкие напоминания
- без зависимости от планов
- используются как основание для устойчивости

### Follow Plan Mode
Привычки = якоря стабильности
- влияют на адаптацию
- помогают удерживать ритм в фазах нагрузки

---

## 5) Explainability

Для каждой привычки:
- «Зачем эта привычка»
- «Как влияет на прогресс»
- «Как влияет на безопасность»

Пример:
> «Регулярность сна улучшает восстановление → снижает риск перегрузки»

---

## 6) UX и психология (Calm Power Coach)
- без стыда, без давления
- поддержка при срыве: «ты не начинаешь сначала, ты возвращаешься»
- локус контроля в руках пользователя

---

## 7) E2E сценарии (новые)
Добавить в `e2e_matrix_v2.md`:
- 211: Создание пользовательской привычки
- 212: Формирование streak
- 213: Срыв → корректный переход в recovery
- 214: Возврат → восстановление стрика
- 215: Влияние привычек на trust/adaptation
- 216: Объяснение привычек в Progress

---

## 8) Data Contracts

### Reads
- `habits`, `habit_logs`
- `user_goals`
- `measurement_history`
- `food_diary_entries`
- `workout_entries`
- `program_sessions`

### Writes
- `habit_logs`
- `habit_state` (derived)
- `trust_score` updates

---

## 9) Offline / Recovery
- local cache стриков
- safe retry при sync
- нет потери данных при offline

---

## 10) Trust & Safety
- низкий streak ≠ «провал»
- минимизация shame копии
- в recovery — мотивация, а не давление

---

## 11) Explainability Bundles
Для каждой метрики привычки:
- `decision_ref`
- `data_sources`
- `confidence`
- `trust_impact`

---

## 12) Integration with Coach Layer
- Coach: мягкое возвращение
- долгосрочная поддержка без гиперконтроля

---

## 13) Implementation Backlog (без кода)
1. Habits Aggregator Service
2. Streak/Recovery logic
3. Explainability hooks
4. Habit → Progress timeline layer
5. Coach messaging rules
